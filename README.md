# Deokso_el_pred

지역 지하수 관리 DB 구축 사업
### 📆_기간

- 2021년 6월 ~ 2021년 7월(2개월)

### 🖍_주제 및 동기

- 덕소 지역의 **강수량에 따른 지하수위 변동을 감시**하기 위함이다.

### 📃_프로젝트 요약

- 덕소 지역의 **8개 관측공에서 측정된 2018년말 부터 2021년 중순까지의 데이터**를 이용, 매일 **익일부터 7일간의 데이터를 예측**한다.
- 예측된 데이터는 실제 데이터와 비교하여 **덕소 지역의 지하수 수위를 감시하고 현황을 파악**한다.

### 🎭_주요 역할

- 8개 지역 지하수 관측공의 과거 데이터를 **전처리하고 시각화** 한다.
- **LSTM** 알고리즘을 이용해 **지하수위 예측 모델**을 만들고, 일 단위로 **지하수위를 감시**할 수 있도록 한다.

### 🌞_세부 역할

- **데이터**
    - 학습 및 예측에 사용되는 데이터는 **서버에 구축된 PostgreDB에서 psycopg2 패키지**를 이용하여 받아왔다.
    - 관측공 데이터는 10분 단위 또는 1시간 단위로 측정되어 있으며 **이상치를 비롯하여 일부 기간 결측**이 존재했다.
        
        : **롤링함수**의 역할을 하는 **pandas의 daterange**를 이용하여 **시간을 index로 지정**, **결측 구간을 찾아내고 보간**하였다. 그러나 장기간의 결측 구간은 보간하지 말라는 요청이 있었기에 보간하지 않았다.
        
        : 다른 시간 단위는 **일 단위를 기준으로 10분 단위 데이터를 다운 샘플링**하여 기준을 맞춰주었다.
        
        : **이상치는 EDA를 통해 확인 후, 제거**하였고 선형보간하였다.
        
- **모델 구축**
    - 학습된 모델은 **60개 셀의 LSTM 레이어 한 층, 50%의 DropOut 한 층, 1개 셀의 Dense 한 층**으로 구성되어 있다.
    - **한 타임스텝마다 다음 날의 수위값을 출력**하는 형태를 띠고 있으며, 셀의 수와 레이어의 수는 **반복 학습을 통한 튜닝**을 통해 이루어졌다.
    - 사용된 손실함수는 MSE, 옵티마이저는 Adam, 활성화 함수는 Tanh이다. 손실함수와 옵티마이저는 반복 학습을 통한 튜닝을 통해 선택되었고, Tanh은 LSTM의 특성에 의해 선택되었다.
- **실서비스의 적용**
    - 출력 데이터는 서버 컴퓨터에서 할당된 DB 테이블에 업로드 되었고, **bat 파일과 윈도우 스케쥴러를 통해 자동화**하였다.
    - DB에서 원본 데이터를 받아 전처리하는 모든 과정과 모델 학습, 출력값 업로드 **모두 한 파일로 이루어진 코드로 작성**되었다. 모**델과 스케일러는 joblib으로 저장**하였고, **결과값들은 csv파일로 오프라인 서버 컴퓨터에 저장**되었다. **동 데이터는 DB에도 업로드** 되었다.
    - 지하수의 일 변화를 매일 확인할 수 있도록 **batch 파일로 python 언어 파일 지정, 소스 파일을 지정하였고 작동**될 수 있게 하였다.
    

### 🛠_사용 기술

- 사용 언어 - Python
- Tool - Jupyter Notebook, VSCode, Google Colab, PostgreSQL
- 사용 라이브러리 - Tensorflow2, Anaconda, Pandas, Numpy
- OS - Window

### 🚣‍♀️_팀 구성

- 사내 총 인원 : 2명
    - DB 관리 : 1명
    - 데이터 분석 : 1명
    

### ‼_이슈

- 데이터 전처리 과정에서 **장기간의 결측 구간**이 발견되었는데, 해당 기간을 **제외하고 가장 긴 기간으로 모델을 만들어달라**는 요청이 있었다.
    - **일일이 확인해서 모델 구간을 지정하면 자동화가 불가능**하였다. 그래서 **null값이 기록된 구간의 기간과 그렇지 않은 구간의 기간을 계산**하였고, not null 구간 중 가장 긴 기간을 학습에 사용하였다.
- 받은 **데이터의 날짜 모두가 str로 인식**되고, **pandas의 변환 기능 사용시 1970년으로 인식되는 에러**가 있었다.
    - **str 날짜를 글자 수대로 슬라이싱하여 각각 ‘년‘, ‘월‘, ‘일‘로 지정하였고 나중에 합치는 과정**을 통해 맞는 날짜로 변환하였다.
    

### 💡_배운 것

- **DB로부터 데이터를 받아오고 가공된 데이터를 업로드 하는 일련의 과정**을 처음 했던 프로젝트였다. 이를 통해 추후 진행된 프로젝트에서 다양한 DB와의 연동을 손쉽게 할 수 있었다.
- **시계열 데이터 가공의 여러 접근법을 연구**해 볼 수 있었다. 또한, **결측기간과 기록기간을 set_index를 통해 구분하고 보간하는 방법**들에 대해 알게 되었다. 결과적으로 시계열 데이터 가공에 자신감을 가질 수 있었다.
- 모델 뿐만 아니라 **스케일러도 저장 후 같은 스케일을 적용하고, transform, inverse_transform의 활용할 수 있다**는 것을 배울 수 있었다.
- 작성한 코드와 생성한 모델 등을 **bat 파일을 이용해 설정된 과정을 거치는 자동화 작업을 하고, 나아가 실서비스**를 해볼 수 있었던 기회였다.
- **여러 하이퍼파라미터를 반복 학습시키며 session을 초기화**하는 법을 알게 되었다.


### 🧵관련 프로젝트

- 한국 수자원 공사 낙동강보 관리단, 창녕 함안보 지하수 연구
    - 2021년 8월 ~ 2021년 9월(총 2개월)
    - 데이터 전처리, 예측 모델 개발 및 EDA(100% 기여-단독진행)
    - 수자원 공사 창녕 함안보 유역 지하수 관측공 40여개소 중 선별된 4개소의 10년치 지하수 수위 데이터, 함안보 유역 낙동강의 10년치 수위 데이터, 함안보 유역의 10년치 강수 데이터
    - 이전 지하수위 데이터를 shift하고, 강수량과 낙동강 수위를 독립변수로 함께 활용하여 다음 수위값을 예측하는 형식
    - LSTM을 활용한 예측 모델 개발로 **한국 수자원 공사 낙동강보 관리단 내부 발표 진행됨**
    - Anomaly Detection에 대한 기본을 쌓을 수 있었던 계기가 되었고, 1시간, 24시간, 15일, 30일 단위 등 다양한 기간에 대한 예측을 시도해볼 수 있었다. **시계열 데이터의 정태성, 동향, 추세, 분포 등 고유 성질에 대한 여러 공부를 할 수 있었던 연구과제**였다.
- 한국 수자원 공사, 광주 장성남면 지하수 연구
    - 2021년 10월 (총 1개월)
    - 데이터 전처리, 예측 모델 개발 및 EDA(100% 기여-단독진행)
    - 수자원 공사 광주 장성남면 지하수 관측공 1개소의 11년치 지하수 수위 데이터, 장성남면의 10년치 강수 데이터
    - 이전 지하수위 데이터를 shift하고, 강수량과 낙동강 수위를 독립변수로 함께 활용하여 다음 수위값을 예측하는 형식
    - 수자원 공사로부터 제공받은 강수량 데이터의 **이상치와 결측치가 이동평균 등으로 보정할 수 없는 수준**이었다. 때문에 **기상청의 해당 지역 데이터를 참고하여 이상치를 판별**하여야 했다.
- 서울대학교 대학원 산학 협업 프로젝트
    - 2021년 10월 (총 1개월)
    - 특정 지역의 지하수 관측공 2개소의 지하수위 시계열 데이터
    - **강수량이나 다른 독립변수 없이 지하수위만으로 미래의 지하수 수위를 예측하는 형태**였다.
    - 보안의 이유로 데이터에 대한 아무런 정보 없이 기록된 데이터만 제공받고 모델을 생성해야 했던 것이 아쉬움으로 남았다. 또한, **모델 구축에 제공되는 독립변수의 수가 제한적이어서 1개 관측공에서 좋은 결과를 낼 수 없었다**.
